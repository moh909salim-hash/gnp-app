<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GNP v4 Pro — Protocol Enforcer + PDF Study (Single File)</title>

  <!-- pdf.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --line:#2b2f3a; --line2:#394055;
      --txt:#e6e6e6; --muted:rgba(230,230,230,.75);
      --btn:#141827; --btn2:#0f1220;
      --good:#7CFC90; --bad:#ff6b6b; --warn:#ffcc66;
      --hl: rgba(255, 230, 120, .25);
    }
    body{font-family:system-ui,-apple-system,Arial; margin:16px; background:var(--bg); color:var(--txt);}
    h1,h2,h3{margin:0 0 8px 0}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width: 980px){ .grid{grid-template-columns: 1.05fr .95fr;} }

    .card{border:1px solid var(--line); border-radius:14px; padding:14px; background:var(--panel);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid var(--line2); background:var(--btn); color:var(--txt); padding:10px 12px; border-radius:12px; cursor:pointer}
    .btn:disabled{opacity:.35; cursor:not-allowed}
    .btn.ghost{background:transparent}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    textarea,input,select{
      width:100%; box-sizing:border-box; padding:10px; border-radius:12px;
      border:1px solid var(--line2); background:var(--btn2); color:var(--txt)
    }
    .small{opacity:.8; font-size:12px; color:var(--muted)}
    .tag{padding:4px 10px; border:1px solid var(--line2); border-radius:999px; font-size:12px; opacity:.95}
    .bad{color:var(--bad)} .good{color:var(--good)} .warn{color:var(--warn)}
    .hide{display:none}
    .log{max-height:220px; overflow:auto; background:#0a0c14; border-radius:12px; padding:10px; border:1px solid var(--line)}
    a{color:#9ecbff}

    /* PDF viewer */
    .pdfWrap{display:grid; grid-template-columns: 1fr; gap:10px;}
    .pdfStage{
      position:relative; border:1px solid var(--line); border-radius:14px;
      background:#0a0c14; overflow:hidden;
    }
    canvas{display:block; width:100%; height:auto}
    .overlay{
      position:absolute; inset:0; pointer-events:none;
    }
    .hlBox{
      position:absolute; background:var(--hl);
      border:1px solid rgba(255,230,120,.5);
      border-radius:6px;
    }
    .dragBox{
      position:absolute; border:1px dashed rgba(255,230,120,.9);
      background: rgba(255,230,120,.12);
      border-radius:6px;
    }
    .split{
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    @media(min-width:980px){ .split{grid-template-columns: 1fr 1fr;} }

    .kpi{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .kpi .tag{background:rgba(255,255,255,.03)}
  </style>
</head>

<body>

<div class="card">
  <div class="row">
    <div>
      <div class="mono" style="font-size:16px;">GNP v4 PRO — Interview Edition</div>
      <div class="small">Protocol Enforcer + PDF Study (Single File). كل شيء يُحفظ محليًا.</div>
    </div>
    <div style="margin-inline-start:auto" class="kpi">
      <span class="tag mono" id="modeTag">MODE: IDLE</span>
      <span class="tag mono" id="stepTag">STEP: -/-</span>
    </div>
  </div>
</div>

<div class="grid">

  <!-- LEFT: PDF STUDY -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="mono">PDF STUDY</div>
        <div class="small">رفع PDF، تصفح، تظليل بالمربعات، ملاحظات، وتصدير/استيراد.</div>
      </div>
      <div class="row">
        <button class="btn mono ghost" onclick="exportAll()">EXPORT ALL</button>
        <button class="btn mono ghost" onclick="importAll()">IMPORT</button>
        <button class="btn mono" onclick="clearAll()">CLEAR</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="pdfInput" type="file" accept="application/pdf" />
      <button class="btn mono" onclick="loadSelectedPdf()">LOAD PDF</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn mono" id="prevBtn" onclick="prevPage()" disabled>◀ PREV</button>
      <button class="btn mono" id="nextBtn" onclick="nextPage()" disabled>NEXT ▶</button>

      <span class="tag mono" id="pageTag">PAGE: -/-</span>

      <label class="tag mono" style="display:flex; gap:8px; align-items:center; cursor:pointer;">
        <input type="checkbox" id="drawToggle" onchange="setDrawMode(this.checked)" />
        DRAW HIGHLIGHT
      </label>

      <button class="btn mono" id="extractBtn" onclick="extractPageTextToStep3()" disabled>SEND PAGE TEXT → STEP 3</button>
    </div>

    <div class="pdfWrap" style="margin-top:10px">
      <div class="pdfStage" id="pdfStage">
        <canvas id="pdfCanvas"></canvas>
        <div class="overlay" id="overlay"></div>
      </div>

      <div class="split">
        <div class="card" style="background:transparent; border-color:var(--line)">
          <div class="mono">HIGHLIGHTS (THIS PAGE)</div>
          <div class="small">اضغط على هايلايت لحذف/تعديل ملاحظته.</div>
          <div id="hlList" class="small" style="margin-top:10px"></div>
        </div>
        <div class="card" style="background:transparent; border-color:var(--line)">
          <div class="mono">PAGE NOTES</div>
          <textarea id="pageNote" rows="7" placeholder="ملاحظات الصفحة (تُحفظ تلقائيًا)..."></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn mono" onclick="savePageNote()">SAVE NOTE</button>
            <span class="small" id="noteMsg"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="small" style="margin-top:10px">
      التظليل هنا **مربعات** (Drag). هذا أسهل وأثبت على الجوال. نقدر لاحقًا نطوره لتظليل نصّي دقيق.
    </div>
  </div>

  <!-- RIGHT: GNP ENFORCER -->
  <div>
    <div class="card">
      <div class="row">
        <button class="btn mono" onclick="handleCmd('READY')">READY</button>
        <button class="btn mono" onclick="handleCmd('STOP')">STOP</button>
        <button class="btn mono" onclick="handleCmd('TEST ME')">TEST ME</button>
        <button class="btn mono" onclick="handleCmd('SCENARIO DRILL')">SCENARIO DRILL</button>
        <button class="btn mono" onclick="exportLog()">EXPORT LOG</button>
        <button class="btn mono" onclick="hardReset()">HARD RESET</button>
      </div>

      <div style="margin-top:10px" class="row">
        <input id="cmdInput" class="mono" placeholder="اكتب أمر: OVERRIDE 5 | RESET 3" />
        <button class="btn mono" onclick="execInputCmd()">EXEC</button>
      </div>
      <div class="small">OVERRIDE/RESET مسموحة فقط مع تسجيل إلزامي في السجل.</div>
    </div>

    <div class="card hide" id="stepCard">
      <div class="row">
        <div class="mono" id="stepTitle" style="font-size:16px;"></div>
        <div style="margin-inline-start:auto" class="row">
          <span class="tag mono" id="timerTag">T: --</span>
          <span class="tag mono" id="wordsTag">W: 0/0</span>
        </div>
      </div>

      <div style="margin-top:10px" id="promptText"></div>
      <div class="small" style="margin-top:8px">Encoding required: Visual / Auditory / Kinesthetic / Emotional + Scenario Anchor</div>

      <div style="margin-top:10px" class="row">
        <textarea id="answer" rows="6" placeholder="اكتب Output هنا (مطلوب)."></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn mono" id="submitBtn" onclick="submitOutput()">SUBMIT OUTPUT</button>
        <span id="statusMsg" class="small"></span>
      </div>

      <div class="small" style="margin-top:10px">
        تلميح: لازم داخل Output تكتب: <span class="mono">V: A: K: E: S:</span>
      </div>
    </div>

    <div class="card">
      <div class="mono">AUDIT LOG</div>
      <div class="small">كل أمر/خطوة/انتهاء وقت يُسجل دائمًا.</div>
      <div class="log mono" id="logBox" style="margin-top:10px"></div>
    </div>
  </div>

</div>

<script>
/* =========================
   GNP ENFORCER (15 steps)
========================= */
const STEPS = [
  {n:1,  t:"Neuro-Priming Start",       w:60,  sec:60,  mod:["Visual","Emotional"]},
  {n:2,  t:"Scope Lock",                w:50,  sec:45,  mod:["Auditory","Emotional"]},
  {n:3,  t:"Raw Facts Extraction",      w:120, sec:120, mod:["Visual"]},
  {n:4,  t:"3-2-1 Cutoff",              w:60,  sec:60,  mod:["Kinesthetic"]},
  {n:5,  t:"Risk & Control Mapping",    w:110, sec:140, mod:["Visual","Kinesthetic"]},
  {n:6,  t:"Roles & Accountability",    w:90,  sec:110, mod:["Auditory"]},
  {n:7,  t:"Failure Modes",             w:100, sec:120, mod:["Visual"]},
  {n:8,  t:"Zeigarnik Questions",       w:80,  sec:80,  mod:["Emotional"]},
  {n:9,  t:"Memory Palace Anchors",     w:90,  sec:100, mod:["Visual","Kinesthetic"]},
  {n:10, t:"Interview Q&A (Hard)",      w:100, sec:120, mod:["Auditory","Emotional"]},
  {n:11, t:"Field Execution Checklist", w:120, sec:130, mod:["Kinesthetic"]},
  {n:12, t:"Red Flags / Stop-Work",     w:90,  sec:90,  mod:["Emotional"]},
  {n:13, t:"Micro-Test ضغط",            w:60,  sec:60,  mod:["Auditory"]},
  {n:14, t:"Error Log (Anti-Repeat)",   w:90,  sec:90,  mod:["Visual","Emotional"]},
  {n:15, t:"60-Second Closure",         w:70,  sec:70,  mod:["Auditory","Kinesthetic"]},
];

const PROMPTS = {
  1:"ادخل وضع READY: صف 1 صورة + 1 شعور + 1 سبب. (Encoding كامل).",
  2:"اقفل النطاق: 3 حقائق + 2 خيارات + 1 خطوة الآن. (3-2-1).",
  3:"استخرج حقائق خام: نقاط فقط بدون تفسير. (يمكنك سحب نص صفحة PDF هنا).",
  4:"طبّق 3-2-1 على ما سبق: (3 Facts / 2 Options / 1 Next).",
  5:"خريطة مخاطر: Hazard → Risk → Controls (Top 5).",
  6:"RACI مصغر: Who does what + accountability.",
  7:"Failure modes: كيف يفشل النظام؟ (5 طرق).",
  8:"Zeigarnik: اكتب أسئلة معلّقة لا تعرف جوابها.",
  9:"Memory Palace: اربط 3 نقاط بمكان/ممر/علامة.",
  10:"Q&A صعب: سؤال + جواب مختصر + دليل واحد.",
  11:"Checklist: خطوات تنفيذ ميداني (10 بنود).",
  12:"Stop-Work triggers: 5 إشارات حمراء توقف عندها فورًا.",
  13:"Micro-test: استرجاع 5 نقاط خلال الوقت فقط.",
  14:"Error log: خطأ واحد + سبب + قاعدة منع تكرار.",
  15:"Closure: 60 ثانية — 3 حقائق / 2 ثغرات / 1 خطة غد.",
};

let state = loadState() || {
  mode: "IDLE",
  i: -1,
  locked: true,
  startedAt: null,
  stepStartedAt: null,
  timeLeft: 0,
  log: []
};
let timer = null;

const modeTag = document.getElementById("modeTag");
const stepTag = document.getElementById("stepTag");
const timerTag = document.getElementById("timerTag");
const wordsTag = document.getElementById("wordsTag");
const stepCard = document.getElementById("stepCard");
const stepTitle = document.getElementById("stepTitle");
const promptText = document.getElementById("promptText");
const answer = document.getElementById("answer");
const submitBtn = document.getElementById("submitBtn");
const statusMsg = document.getElementById("statusMsg");
const logBox = document.getElementById("logBox");

renderAll();

function handleCmd(cmdRaw){
  const cmd = (cmdRaw||"").trim().toUpperCase();
  if(cmd === "READY"){ startRun(); return; }
  if(cmd === "STOP"){ stopRun(); return; }
  if(cmd === "TEST ME"){
    state.mode = "TEST";
    logEvent("COMMAND","TEST ME",{});
    saveState(); renderAll();
    return;
  }
  if(cmd === "SCENARIO DRILL"){
    state.mode = "SCENARIO";
    if(state.i < 0) state.i = 0;
    logEvent("COMMAND","SCENARIO DRILL",{});
    startStep(state.i);
    return;
  }
  if(cmd.startsWith("OVERRIDE")){
    const n = parseInt(cmd.split(/\s+/)[1],10);
    if(Number.isFinite(n) && n>=1 && n<=15){
      logEvent("OVERRIDE",`TO_STEP_${n}`,{reason:"manual"});
      state.i = n-1; state.mode = "RUN";
      startStep(state.i);
    }
    return;
  }
  if(cmd.startsWith("RESET")){
    const n = parseInt(cmd.split(/\s+/)[1],10);
    if(Number.isFinite(n) && n>=1 && n<=15){
      logEvent("RESET",`STEP_${n}`,{});
      state.i = n-1; state.mode = "RUN";
      startStep(state.i);
    }
    return;
  }
  logEvent("COMMAND_UNKNOWN",cmd,{});
  saveState(); renderAll();
}

function execInputCmd(){
  const v = document.getElementById("cmdInput").value || "";
  document.getElementById("cmdInput").value = "";
  handleCmd(v);
}

function startRun(){
  clearTimer();
  state.mode = "RUN";
  state.i = 0;
  state.startedAt = new Date().toISOString();
  logEvent("SESSION_START","READY",{});
  startStep(0);
}

function stopRun(){
  clearTimer();
  state.mode = "PAUSED";
  logEvent("SESSION_STOP","STOP",{atStep: state.i+1});
  saveState(); renderAll();
}

function startStep(i){
  clearTimer();
  state.i = i;
  state.stepStartedAt = new Date().toISOString();
  const step = STEPS[i];
  state.timeLeft = step.sec;
  logEvent("STEP_START",`STEP_${step.n}`,{mode: state.mode});
  saveState();
  renderAll();
  tick();
}

function tick(){
  clearTimer();
  timer = setInterval(()=>{
    if(state.mode === "PAUSED" || state.mode === "IDLE") return;
    state.timeLeft -= 1;
    if(state.timeLeft <= 0){
      state.timeLeft = 0;
      clearTimer();
      logEvent("TIMEOUT",`STEP_${STEPS[state.i].n}`,{});
      saveState();
      renderAll();

      if(state.mode === "SCENARIO"){
        if(state.i < 14) startStep(state.i+1);
        else {
          state.mode = "IDLE";
          logEvent("SCENARIO_END","DONE",{});
          saveState(); renderAll();
        }
      } else {
        submitBtn.disabled = true;
        statusMsg.innerHTML = `<span class="bad">انتهى الوقت. استخدم RESET أو OVERRIDE.</span>`;
      }
    } else {
      saveState();
      renderAll(false);
    }
  },1000);
}

function submitOutput(){
  const txt = (answer.value || "").trim();
  if(!txt){ statusMsg.innerHTML = `<span class="bad">Output فارغ. ممنوع.</span>`; return; }
  const step = STEPS[state.i];

  const wc = wordCount(txt);
  if(wc > step.w){ statusMsg.innerHTML = `<span class="bad">تجاوزت حد الكلمات (${wc}/${step.w}). قصّ النص.</span>`; return; }
  if(state.timeLeft <= 0 && state.mode !== "SCENARIO"){ statusMsg.innerHTML = `<span class="bad">الوقت انتهى. RESET أو OVERRIDE.</span>`; return; }

  const needs = ["V:","A:","K:","E:","S:"];
  const missing = needs.filter(k => !txt.toUpperCase().includes(k));
  if(missing.length){
    statusMsg.innerHTML = `<span class="bad">Encoding ناقص. لازم داخل Output: V: A: K: E: S:</span>`;
    return;
  }

  logEvent("STEP_OUTPUT",`STEP_${step.n}`,{text: txt, words: wc, timeUsed: step.sec - state.timeLeft});
  answer.value = "";
  statusMsg.innerHTML = `<span class="good">تم حفظ الـOutput. فتح التالي.</span>`;

  if(state.i < 14) startStep(state.i+1);
  else {
    clearTimer();
    logEvent("SESSION_COMPLETE","DONE",{});
    state.mode = "IDLE";
    state.i = -1;
    saveState();
    renderAll();
  }
}

function renderAll(full=true){
  modeTag.textContent = `MODE: ${state.mode}`;
  stepTag.textContent = state.i>=0 ? `STEP: ${state.i+1}/15` : `STEP: -/-`;

  if(state.i>=0){
    const step = STEPS[state.i];
    stepCard.classList.remove("hide");
    stepTitle.textContent = `Step ${step.n}: ${step.t}  [${step.mod.join(", ")}]`;
    promptText.textContent = PROMPTS[step.n] || "";
    timerTag.textContent = `T: ${state.timeLeft}s`;
    wordsTag.textContent = `W: ${wordCount(answer.value||"")}/${step.w}`;
    submitBtn.disabled = (state.mode==="PAUSED" || state.mode==="IDLE");
  } else {
    stepCard.classList.add("hide");
  }
  renderLog();
}

answer.addEventListener("input", ()=>{
  if(state.i<0) return;
  const step = STEPS[state.i];
  const wc = wordCount(answer.value||"");
  wordsTag.textContent = `W: ${wc}/${step.w}`;
});

function renderLog(){
  const lines = state.log.slice(-60).map(e => `[${e.ts}] ${e.type} ${e.name} ${e.data?JSON.stringify(e.data):""}`);
  logBox.textContent = lines.join("\n");
}

function logEvent(type,name,data){ state.log.push({ts:new Date().toISOString(), type, name, data}); }
function saveState(){ localStorage.setItem("GNPv4_STATE", JSON.stringify(state)); }
function loadState(){ try{ const s = localStorage.getItem("GNPv4_STATE"); return s?JSON.parse(s):null; }catch(e){ return null; } }
function exportLog(){
  const blob = new Blob([JSON.stringify(state.log,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="gnp_audit_log.json"; a.click();
  URL.revokeObjectURL(url);
}
function hardReset(){
  if(!confirm("HARD RESET يمسح كل شيء (state + log + pdf data). موافق؟")) return;
  clearTimer();
  localStorage.removeItem("GNPv4_STATE");
  localStorage.removeItem("PDF_STUDY_STATE");
  state = {mode:"IDLE", i:-1, locked:true, startedAt:null, stepStartedAt:null, timeLeft:0, log:[]};
  resetPdfStateOnly();
  renderAll();
}
function clearTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function wordCount(t){ return (t||"").trim().split(/\s+/).filter(Boolean).length; }

/* =========================
   PDF STUDY (pdf.js)
   - Load PDF (stored in IndexedDB? no; we store in memory + study state in localStorage)
   - Highlights as rectangles in page coords
   - Page notes
========================= */

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

const pdfInput = document.getElementById("pdfInput");
const pdfCanvas = document.getElementById("pdfCanvas");
const pdfStage = document.getElementById("pdfStage");
const overlay = document.getElementById("overlay");
const pageTag = document.getElementById("pageTag");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const extractBtn = document.getElementById("extractBtn");
const hlList = document.getElementById("hlList");
const pageNote = document.getElementById("pageNote");
const noteMsg = document.getElementById("noteMsg");
const drawToggle = document.getElementById("drawToggle");

let pdfDoc = null;
let pdfBytes = null;
let view = {
  page: 1,
  pages: 0,
  scale: 1.2,
  viewport: null,
  rendering: false,
  drawMode: false,
  drag: null
};

let pdfStudy = loadPdfStudyState() || {
  // key: pageNumber => { note: "", highlights: [{id,x,y,w,h,note}] } coordinates in viewport units (unscaled base = 1.0)
  docName: "",
  pages: {}
};

function loadPdfStudyState(){
  try{
    const s = localStorage.getItem("PDF_STUDY_STATE");
    return s ? JSON.parse(s) : null;
  }catch(e){ return null; }
}
function savePdfStudyState(){ localStorage.setItem("PDF_STUDY_STATE", JSON.stringify(pdfStudy)); }

function resetPdfStateOnly(){
  pdfDoc = null; pdfBytes = null;
  view.page = 1; view.pages = 0;
  overlay.innerHTML = "";
  pageTag.textContent = "PAGE: -/-";
  prevBtn.disabled = true; nextBtn.disabled = true;
  extractBtn.disabled = true;
  hlList.innerHTML = "";
  pageNote.value = "";
  noteMsg.textContent = "";
}

function loadSelectedPdf(){
  const f = pdfInput.files && pdfInput.files[0];
  if(!f){ alert("اختر ملف PDF أولاً."); return; }
  const reader = new FileReader();
  reader.onload = async () => {
    pdfBytes = new Uint8Array(reader.result);
    await openPdfBytes(pdfBytes, f.name);
  };
  reader.readAsArrayBuffer(f);
}

async function openPdfBytes(bytes, name){
  try{
    pdfDoc = await pdfjsLib.getDocument({data: bytes}).promise;
    view.pages = pdfDoc.numPages;
    view.page = 1;

    pdfStudy.docName = name || "PDF";
    if(!pdfStudy.pages) pdfStudy.pages = {};
    savePdfStudyState();

    prevBtn.disabled = false;
    nextBtn.disabled = false;
    extractBtn.disabled = false;

    await renderPage();
  }catch(e){
    console.error(e);
    alert("فشل فتح PDF. جرّب ملف آخر أو تأكد أن الانترنت شغال أول مرة (pdf.js).");
  }
}

function fitScaleToWidth(viewport){
  // Keep canvas crisp; we scale by devicePixelRatio
  const stageW = pdfStage.clientWidth || 1;
  const desired = stageW / viewport.width;
  return Math.max(0.8, Math.min(2.2, desired));
}

async function renderPage(){
  if(!pdfDoc || view.rendering) return;
  view.rendering = true;

  const page = await pdfDoc.getPage(view.page);
  const baseViewport = page.getViewport({scale: 1});
  const scale = fitScaleToWidth(baseViewport);
  const viewport = page.getViewport({scale});
  view.viewport = viewport;
  view.scale = scale;

  const ctx = pdfCanvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  pdfCanvas.width = Math.floor(viewport.width * dpr);
  pdfCanvas.height = Math.floor(viewport.height * dpr);
  pdfCanvas.style.width = viewport.width + "px";
  pdfCanvas.style.height = viewport.height + "px";
  ctx.setTransform(dpr,0,0,dpr,0,0);

  overlay.style.width = viewport.width + "px";
  overlay.style.height = viewport.height + "px";
  overlay.innerHTML = "";

  pageTag.textContent = `PAGE: ${view.page}/${view.pages}`;

  await page.render({canvasContext: ctx, viewport}).promise;

  // Restore page note + highlights
  loadCurrentPageNote();
  drawHighlights();

  view.rendering = false;
}

function prevPage(){ if(!pdfDoc) return; if(view.page>1){ view.page--; renderPage(); } }
function nextPage(){ if(!pdfDoc) return; if(view.page<view.pages){ view.page++; renderPage(); } }

function setDrawMode(on){
  view.drawMode = !!on;
}

function ensurePageBucket(p){
  if(!pdfStudy.pages[p]) pdfStudy.pages[p] = {note:"", highlights:[]};
  if(!pdfStudy.pages[p].highlights) pdfStudy.pages[p].highlights = [];
  if(typeof pdfStudy.pages[p].note !== "string") pdfStudy.pages[p].note = "";
}

function loadCurrentPageNote(){
  ensurePageBucket(view.page);
  pageNote.value = pdfStudy.pages[view.page].note || "";
  renderHighlightList();
}

function savePageNote(){
  if(!pdfDoc) { noteMsg.innerHTML = `<span class="warn">حمّل PDF أولاً.</span>`; return; }
  ensurePageBucket(view.page);
  pdfStudy.pages[view.page].note = pageNote.value || "";
  savePdfStudyState();
  noteMsg.innerHTML = `<span class="good">تم الحفظ.</span>`;
  setTimeout(()=> noteMsg.textContent = "", 1200);
}

pageNote.addEventListener("input", ()=>{
  if(!pdfDoc) return;
  ensurePageBucket(view.page);
  pdfStudy.pages[view.page].note = pageNote.value || "";
  savePdfStudyState();
});

function rectToCss(r){
  // r stored in viewport units (CSS px at current render scale)
  const el = document.createElement("div");
  el.className = "hlBox";
  el.style.left = r.x + "px";
  el.style.top = r.y + "px";
  el.style.width = r.w + "px";
  el.style.height = r.h + "px";
  return el;
}

function drawHighlights(){
  if(!pdfDoc || !view.viewport) return;
  ensurePageBucket(view.page);
  overlay.innerHTML = "";
  const hs = pdfStudy.pages[view.page].highlights || [];
  hs.forEach(h => overlay.appendChild(rectToCss(h)));
  renderHighlightList();
}

function renderHighlightList(){
  if(!pdfDoc){ hlList.innerHTML = `<span class="warn">حمّل PDF.</span>`; return; }
  ensurePageBucket(view.page);
  const hs = pdfStudy.pages[view.page].highlights || [];
  if(!hs.length){
    hlList.innerHTML = `<span class="small">لا يوجد تظليل في هذه الصفحة.</span>`;
    return;
  }
  hlList.innerHTML = "";
  hs.slice().reverse().forEach(h=>{
    const wrap = document.createElement("div");
    wrap.style.padding = "8px";
    wrap.style.border = "1px solid var(--line)";
    wrap.style.borderRadius = "12px";
    wrap.style.marginBottom = "8px";
    wrap.style.background = "rgba(255,255,255,.02)";
    wrap.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <span class="mono">HL#${h.id}</span>
        <span class="small">x:${Math.round(h.x)} y:${Math.round(h.y)} w:${Math.round(h.w)} h:${Math.round(h.h)}</span>
      </div>
      <textarea rows="2" class="mono" placeholder="ملاحظة لهذا التظليل...">${escapeHtml(h.note||"")}</textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn mono ghost">DELETE</button>
      </div>
    `;
    const ta = wrap.querySelector("textarea");
    const del = wrap.querySelector("button");
    ta.addEventListener("input", ()=>{
      h.note = ta.value || "";
      savePdfStudyState();
    });
    del.addEventListener("click", ()=>{
      pdfStudy.pages[view.page].highlights = (pdfStudy.pages[view.page].highlights||[]).filter(x=>x.id!==h.id);
      savePdfStudyState();
      drawHighlights();
    });
    hlList.appendChild(wrap);
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* Drag highlight (mouse/touch) */
function getLocalPoint(evt){
  const rect = pdfStage.getBoundingClientRect();
  const touch = evt.touches && evt.touches[0];
  const clientX = touch ? touch.clientX : evt.clientX;
  const clientY = touch ? touch.clientY : evt.clientY;
  const x = clientX - rect.left;
  const y = clientY - rect.top;
  return {x, y};
}

function clampRect(r){
  const w = view.viewport ? view.viewport.width : 0;
  const h = view.viewport ? view.viewport.height : 0;
  const x1 = Math.max(0, Math.min(w, r.x1));
  const y1 = Math.max(0, Math.min(h, r.y1));
  const x2 = Math.max(0, Math.min(w, r.x2));
  const y2 = Math.max(0, Math.min(h, r.y2));
  return {x1,y1,x2,y2};
}

function startDrag(evt){
  if(!pdfDoc || !view.drawMode) return;
  evt.preventDefault();
  const p = getLocalPoint(evt);
  view.drag = {x1:p.x, y1:p.y, x2:p.x, y2:p.y, el:null};
  const el = document.createElement("div");
  el.className = "dragBox";
  el.style.left = p.x + "px";
  el.style.top = p.y + "px";
  el.style.width = "1px";
  el.style.height = "1px";
  overlay.appendChild(el);
  view.drag.el = el;
}
function moveDrag(evt){
  if(!view.drag || !view.drawMode) return;
  evt.preventDefault();
  const p = getLocalPoint(evt);
  view.drag.x2 = p.x; view.drag.y2 = p.y;
  const c = clampRect(view.drag);
  const left = Math.min(c.x1,c.x2);
  const top = Math.min(c.y1,c.y2);
  const width = Math.abs(c.x2-c.x1);
  const height = Math.abs(c.y2-c.y1);
  view.drag.el.style.left = left + "px";
  view.drag.el.style.top = top + "px";
  view.drag.el.style.width = width + "px";
  view.drag.el.style.height = height + "px";
}
function endDrag(evt){
  if(!view.drag || !view.drawMode) return;
  evt.preventDefault();

  const c = clampRect(view.drag);
  const x = Math.min(c.x1,c.x2);
  const y = Math.min(c.y1,c.y2);
  const w = Math.abs(c.x2-c.x1);
  const h = Math.abs(c.y2-c.y1);

  // remove drag box
  if(view.drag.el && view.drag.el.parentNode) view.drag.el.parentNode.removeChild(view.drag.el);
  view.drag = null;

  // ignore tiny rect
  if(w < 12 || h < 12) return;

  ensurePageBucket(view.page);
  const id = Date.now().toString().slice(-6);
  pdfStudy.pages[view.page].highlights.push({id, x, y, w, h, note:""});
  savePdfStudyState();
  drawHighlights();
}

pdfStage.addEventListener("mousedown", startDrag);
pdfStage.addEventListener("mousemove", moveDrag);
window.addEventListener("mouseup", endDrag);

pdfStage.addEventListener("touchstart", startDrag, {passive:false});
pdfStage.addEventListener("touchmove", moveDrag, {passive:false});
window.addEventListener("touchend", endDrag, {passive:false});

/* Extract page text and push into Step 3 */
async function extractPageTextToStep3(){
  if(!pdfDoc) return;
  const page = await pdfDoc.getPage(view.page);
  const tc = await page.getTextContent();
  const text = tc.items.map(i => i.str).join(" ").replace(/\s+/g," ").trim();

  // Ensure we are in Step 3; if not, we don't force — we inject at cursor.
  if(state.i !== 2){
    // move to step 3 without breaking rules? we won't auto-override.
    // We'll just paste into current answer with prefix, user decides.
    answer.value = (answer.value||"") + "\n" + "[PDF PAGE TEXT] " + text.slice(0, 2000);
    answer.dispatchEvent(new Event("input"));
    statusMsg.innerHTML = `<span class="warn">تم إرسال النص داخل الـOutput الحالي. إذا تريد Step 3 استخدم OVERRIDE 3.</span>`;
    return;
  }
  // Step 3 active:
  answer.value = text.slice(0, 4000);
  answer.dispatchEvent(new Event("input"));
  statusMsg.innerHTML = `<span class="good">تم إدخال نص الصفحة في Step 3. الآن حوّله لحقائق خام (نقاط فقط).</span>`;
}

/* Export / Import full data */
function exportAll(){
  const payload = {
    gnp: state,
    pdfStudy,
    meta: { exportedAt: new Date().toISOString() }
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "gnp_pdf_study_export.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAll(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const f = inp.files && inp.files[0];
    if(!f) return;
    const txt = await f.text();
    try{
      const data = JSON.parse(txt);
      if(data.gnp) { state = data.gnp; saveState(); }
      if(data.pdfStudy) { pdfStudy = data.pdfStudy; savePdfStudyState(); }
      renderAll();
      // redraw highlights if pdf loaded
      drawHighlights();
      alert("تم الاستيراد.");
    }catch(e){
      alert("ملف الاستيراد غير صالح.");
    }
  };
  inp.click();
}

function clearAll(){
  if(!confirm("سيتم مسح (GNP + PDF Notes/Highlights). موافق؟")) return;
  localStorage.removeItem("GNPv4_STATE");
  localStorage.removeItem("PDF_STUDY_STATE");
  state = {mode:"IDLE", i:-1, locked:true, startedAt:null, stepStartedAt:null, timeLeft:0, log:[]};
  pdfStudy = {docName:"", pages:{}};
  resetPdfStateOnly();
  renderAll();
}

/* Restore PDF notes state even before loading a PDF */
(function boot(){
  // keep existing notes in localStorage (already loaded into pdfStudy)
  // nothing else.
})();
</script>

</body>
</html>