<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GNP v4 Pro — Protocol Enforcer + PDF Study (MVP)</title>

  <!-- PDF.js (stable) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Worker must match version
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <style>
    :root{
      --bg:#0b0c10; --card:#11131a; --card2:#0a0c14;
      --text:#e6e6e6; --muted:#a6adbb; --line:#2b2f3a; --line2:#394055;
      --good:#7CFC90; --bad:#ff6b6b; --warn:#ffcc66;
    }
    body{font-family:system-ui,-apple-system,Arial; margin:16px; background:var(--bg); color:var(--text);}
    .card{border:1px solid var(--line); border-radius:12px; padding:14px; background:var(--card); margin-bottom:12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid var(--line2); background:#141827; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer}
    .btn:disabled{opacity:.35; cursor:not-allowed}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    textarea,input{width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid var(--line2); background:#0f1220; color:var(--text)}
    .small{opacity:.8; font-size:12px; color:var(--muted)}
    .tag{padding:4px 8px; border:1px solid var(--line2); border-radius:999px; font-size:12px; opacity:.95}
    .bad{color:var(--bad)} .good{color:var(--good)} .warn{color:var(--warn)}
    .hide{display:none}
    .log{max-height:180px; overflow:auto; background:var(--card2); border-radius:10px; padding:10px; border:1px solid var(--line)}
    a{color:#9ecbff}
    .split{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:980px){ .split{grid-template-columns: 1.1fr 0.9fr;} }
    canvas{width:100%; height:auto; background:#000; border-radius:12px; border:1px solid var(--line)}
    .pill{border:1px solid var(--line2); border-radius:999px; padding:6px 10px; background:#0f1220}
    .hr{height:1px; background:var(--line); margin:10px 0}
    .k{display:grid; grid-template-columns:1fr; gap:8px}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="card">
    <div class="row">
      <div>
        <div class="mono" style="font-size:16px;">GNP v4 PRO — Interview Edition</div>
        <div class="small">Protocol Enforcer + PDF Study (Personal MVP) — Locked 15-step sequence</div>
      </div>
      <div style="margin-inline-start:auto" class="row">
        <span class="tag mono" id="modeTag">MODE: IDLE</span>
        <span class="tag mono" id="stepTag">STEP: -/-</span>
      </div>
    </div>
  </div>

  <div class="split">

    <!-- LEFT: PDF STUDY -->
    <div class="card">
      <div class="row">
        <div class="mono">PDF STUDY</div>
        <span class="pill mono" id="pdfStatus">PDF: not loaded</span>
        <span class="pill mono" id="pageInfo">PAGE: -/-</span>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="pdfInput" type="file" accept="application/pdf" />
        <button class="btn mono" id="loadPdfBtn">LOAD PDF</button>
        <button class="btn mono" id="clearPdfBtn">CLEAR</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn mono" id="prevPageBtn" disabled>PREV</button>
        <button class="btn mono" id="nextPageBtn" disabled>NEXT</button>
        <button class="btn mono" id="toggleHighlightBtn" disabled>DRAW HIGHLIGHT: OFF</button>
        <button class="btn mono" id="clearHighlightsBtn" disabled>CLEAR HIGHLIGHTS</button>
      </div>

      <div style="margin-top:10px">
        <canvas id="pdfCanvas"></canvas>
      </div>

      <div class="hr"></div>

      <div class="k">
        <div>
          <div class="mono">HIGHLIGHTS (THIS PAGE)</div>
          <div class="small">تسحب بإصبعك على الصفحة لعمل Highlight (إذا ON). محفوظ محليًا.</div>
          <div class="log mono" id="hlList" style="margin-top:8px"></div>
        </div>

        <div>
          <div class="mono">PAGE NOTES</div>
          <textarea id="pageNotes" rows="4" placeholder="ملاحظات هذه الصفحة..."></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn mono" id="saveNoteBtn" disabled>SAVE NOTE</button>
            <span class="small" id="noteMsg"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: GNP ENFORCER -->
    <div>
      <div class="card">
        <div class="row">
          <button class="btn mono" onclick="handleCmd('READY')">READY</button>
          <button class="btn mono" onclick="handleCmd('STOP')">STOP</button>
          <button class="btn mono" onclick="handleCmd('TEST ME')">TEST ME</button>
          <button class="btn mono" onclick="handleCmd('SCENARIO DRILL')">SCENARIO DRILL</button>
          <button class="btn mono" onclick="exportLog()">EXPORT LOG</button>
          <button class="btn mono" onclick="hardReset()">HARD RESET</button>
        </div>

        <div style="margin-top:10px" class="row">
          <input id="cmdInput" class="mono" placeholder="أمر: OVERRIDE 5 | RESET 3" />
          <button class="btn mono" onclick="execInputCmd()">EXEC</button>
        </div>
        <div class="small">OVERRIDE/RESET مسموحة فقط مع تسجيل إلزامي في السجل.</div>
      </div>

      <div class="card hide" id="stepCard">
        <div class="row">
          <div class="mono" id="stepTitle" style="font-size:16px;"></div>
          <div style="margin-inline-start:auto" class="row">
            <span class="tag mono" id="timerTag">T: --</span>
            <span class="tag mono" id="wordsTag">W: 0/0</span>
          </div>
        </div>

        <div style="margin-top:10px" id="promptText" class="mono"></div>
        <div class="small" style="margin-top:8px">Encoding required in Output: <span class="mono">V: A: K: E: S:</span></div>

        <div style="margin-top:10px" class="row">
          <textarea id="answer" rows="5" placeholder="اكتب Output هنا (مطلوب)."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn mono" id="submitBtn" onclick="submitOutput()">SUBMIT OUTPUT</button>
          <span id="statusMsg" class="small"></span>
        </div>
      </div>

      <div class="card">
        <div class="mono">AUDIT LOG</div>
        <div class="small">كل أمر/خطوة/وقت/مخرجات تُسجل.</div>
        <div class="log mono" id="logBox" style="margin-top:10px"></div>
      </div>
    </div>

  </div>

<script>
/* =========================
   GNP ENFORCER (15 steps)
========================= */
const STEPS = [
  {n:1,  t:"Neuro-Priming Start",       w:60,  sec:60,  mod:["Visual","Emotional"]},
  {n:2,  t:"Scope Lock",                w:50,  sec:45,  mod:["Auditory","Emotional"]},
  {n:3,  t:"Raw Facts Extraction",      w:80,  sec:90,  mod:["Visual"]},
  {n:4,  t:"3-2-1 Cutoff",              w:45,  sec:45,  mod:["Kinesthetic"]},
  {n:5,  t:"Risk & Control Mapping",    w:90,  sec:120, mod:["Visual","Kinesthetic"]},
  {n:6,  t:"Roles & Accountability",    w:70,  sec:90,  mod:["Auditory"]},
  {n:7,  t:"Failure Modes",             w:80,  sec:90,  mod:["Visual"]},
  {n:8,  t:"Zeigarnik Questions",       w:60,  sec:60,  mod:["Emotional"]},
  {n:9,  t:"Memory Palace Anchors",     w:60,  sec:75,  mod:["Visual","Kinesthetic"]},
  {n:10, t:"Interview Q&A (Hard)",      w:80,  sec:90,  mod:["Auditory","Emotional"]},
  {n:11, t:"Field Execution Checklist", w:80,  sec:90,  mod:["Kinesthetic"]},
  {n:12, t:"Red Flags / Stop-Work",     w:60,  sec:60,  mod:["Emotional"]},
  {n:13, t:"Micro-Test ضغط",            w:40,  sec:40,  mod:["Auditory"]},
  {n:14, t:"Error Log (Anti-Repeat)",   w:70,  sec:60,  mod:["Visual","Emotional"]},
  {n:15, t:"60-Second Closure",         w:45,  sec:60,  mod:["Auditory","Kinesthetic"]},
];

const PROMPTS = {
  1:"Step 1: اكتب Output فيه V/A/K/E/S. مثال: V:.. A:.. K:.. E:.. S:..",
  2:"Step 2: اقفل النطاق: 3 حقائق + 2 خيارات + 1 خطوة الآن. ثم V/A/K/E/S.",
  3:"Step 3: حقائق خام من النص (نقاط فقط). ثم V/A/K/E/S.",
  4:"Step 4: طبّق 3-2-1 Cutoff على ما سبق. ثم V/A/K/E/S.",
  5:"Step 5: Hazard → Risk → Controls (Top 5). ثم V/A/K/E/S.",
  6:"Step 6: RACI مصغّر: من يفعل ماذا؟ ثم V/A/K/E/S.",
  7:"Step 7: Failure modes (5 طرق فشل). ثم V/A/K/E/S.",
  8:"Step 8: Zeigarnik: أسئلة معلّقة لا تعرف جوابها. ثم V/A/K/E/S.",
  9:"Step 9: Memory Palace: اربط 3 نقاط بمكان/علامة. ثم V/A/K/E/S.",
  10:"Step 10: سؤال مقابلة صعب + جواب مختصر + دليل واحد. ثم V/A/K/E/S.",
  11:"Step 11: Checklist ميداني (10 بنود). ثم V/A/K/E/S.",
  12:"Step 12: 5 Stop-Work triggers. ثم V/A/K/E/S.",
  13:"Step 13: Micro-test: استرجاع 5 نقاط بسرعة. ثم V/A/K/E/S.",
  14:"Step 14: خطأ واحد + سبب + قاعدة منع تكرار. ثم V/A/K/E/S.",
  15:"Step 15: Closure: 3 حقائق / 2 ثغرات / 1 خطة غد. ثم V/A/K/E/S.",
};

let state = loadState() || {
  mode: "IDLE",
  i: -1,
  startedAt: null,
  stepStartedAt: null,
  timeLeft: 0,
  log: []
};

let timer = null;

const modeTag = document.getElementById("modeTag");
const stepTag = document.getElementById("stepTag");
const timerTag = document.getElementById("timerTag");
const wordsTag = document.getElementById("wordsTag");
const stepCard = document.getElementById("stepCard");
const stepTitle = document.getElementById("stepTitle");
const promptText = document.getElementById("promptText");
const answer = document.getElementById("answer");
const submitBtn = document.getElementById("submitBtn");
const statusMsg = document.getElementById("statusMsg");
const logBox = document.getElementById("logBox");

renderAll();

function handleCmd(cmdRaw){
  const cmd = cmdRaw.trim().toUpperCase();

  if(cmd === "READY"){ startRun(); return; }
  if(cmd === "STOP"){ stopRun(); return; }

  if(cmd === "TEST ME"){
    state.mode = "TEST";
    logEvent("COMMAND","TEST ME",{});
    saveState(); renderAll(); return;
  }

  if(cmd === "SCENARIO DRILL"){
    state.mode = "SCENARIO";
    if(state.i < 0) state.i = 0;
    logEvent("COMMAND","SCENARIO DRILL",{});
    startStep(state.i);
    return;
  }

  if(cmd.startsWith("OVERRIDE")){
    const n = parseInt(cmd.split(/\s+/)[1],10);
    if(Number.isFinite(n) && n>=1 && n<=15){
      logEvent("OVERRIDE",`TO_STEP_${n}`,{reason:"manual"});
      state.i = n-1;
      state.mode = "RUN";
      startStep(state.i);
    }
    return;
  }

  if(cmd.startsWith("RESET")){
    const n = parseInt(cmd.split(/\s+/)[1],10);
    if(Number.isFinite(n) && n>=1 && n<=15){
      logEvent("RESET",`STEP_${n}`,{});
      state.i = n-1;
      state.mode = "RUN";
      startStep(state.i);
    }
    return;
  }

  logEvent("COMMAND_UNKNOWN",cmd,{});
  saveState(); renderAll();
}

function execInputCmd(){
  const v = document.getElementById("cmdInput").value || "";
  document.getElementById("cmdInput").value = "";
  handleCmd(v);
}

function startRun(){
  clearTimer();
  state.mode = "RUN";
  state.i = 0;
  state.startedAt = new Date().toISOString();
  logEvent("SESSION_START","READY",{});
  startStep(0);
}

function stopRun(){
  clearTimer();
  state.mode = "PAUSED";
  logEvent("SESSION_STOP","STOP",{atStep: state.i+1});
  saveState(); renderAll();
}

function startStep(i){
  clearTimer();
  state.i = i;
  state.stepStartedAt = new Date().toISOString();
  const step = STEPS[i];
  state.timeLeft = step.sec;
  logEvent("STEP_START",`STEP_${step.n}`,{mode: state.mode});
  saveState();
  renderAll();
  tick();
}

function tick(){
  clearTimer();
  timer = setInterval(()=>{
    if(state.mode === "PAUSED" || state.mode === "IDLE") return;

    state.timeLeft -= 1;

    if(state.timeLeft <= 0){
      state.timeLeft = 0;
      clearTimer();
      logEvent("TIMEOUT",`STEP_${STEPS[state.i].n}`,{});
      saveState();
      renderAll();

      if(state.mode === "SCENARIO"){
        if(state.i < 14){ startStep(state.i+1); }
        else {
          state.mode = "IDLE";
          logEvent("SCENARIO_END","DONE",{});
          saveState(); renderAll();
        }
      } else {
        submitBtn.disabled = true;
        statusMsg.innerHTML = `<span class="bad">انتهى الوقت. استخدم RESET أو OVERRIDE.</span>`;
      }
    } else {
      saveState();
      renderAll(false);
    }
  },1000);
}

function submitOutput(){
  const txt = (answer.value || "").trim();
  if(!txt){ statusMsg.innerHTML = `<span class="bad">Output فارغ. ممنوع.</span>`; return; }

  const step = STEPS[state.i];
  const wc = wordCount(txt);

  if(wc > step.w){
    statusMsg.innerHTML = `<span class="bad">تجاوزت حد الكلمات (${wc}/${step.w}).</span>`;
    return;
  }

  if(state.timeLeft <= 0 && state.mode !== "SCENARIO"){
    statusMsg.innerHTML = `<span class="bad">الوقت انتهى. RESET أو OVERRIDE.</span>`;
    return;
  }

  const needs = ["V:","A:","K:","E:","S:"];
  const up = txt.toUpperCase();
  const missing = needs.filter(k => !up.includes(k));
  if(missing.length){
    statusMsg.innerHTML = `<span class="bad">Encoding ناقص. لازم: V: A: K: E: S:</span>`;
    return;
  }

  logEvent("STEP_OUTPUT",`STEP_${step.n}`,{text: txt, words: wc, timeUsed: step.sec - state.timeLeft});
  answer.value = "";
  statusMsg.innerHTML = `<span class="good">تم. فتح التالي.</span>`;

  if(state.i < 14){ startStep(state.i+1); }
  else {
    clearTimer();
    logEvent("SESSION_COMPLETE","DONE",{});
    state.mode = "IDLE";
    state.i = -1;
    saveState();
    renderAll();
  }
}

function renderAll(){
  modeTag.textContent = `MODE: ${state.mode}`;
  stepTag.textContent = state.i>=0 ? `STEP: ${state.i+1}/15` : `STEP: -/-`;

  if(state.i>=0){
    const step = STEPS[state.i];
    stepCard.classList.remove("hide");
    stepTitle.textContent = `Step ${step.n}: ${step.t}  [${step.mod.join(", ")}]`;
    promptText.textContent = PROMPTS[step.n] || "";
    timerTag.textContent = `T: ${state.timeLeft}s`;
    wordsTag.textContent = `W: 0/${step.w}`;
    submitBtn.disabled = (state.mode==="PAUSED" || state.mode==="IDLE");
  } else {
    stepCard.classList.add("hide");
  }
  renderLog();
}

answer.addEventListener("input", ()=>{
  if(state.i<0) return;
  const step = STEPS[state.i];
  const wc = wordCount(answer.value||"");
  wordsTag.textContent = `W: ${wc}/${step.w}`;
});

function renderLog(){
  const lines = state.log.slice(-50).map(e=>{
    return `[${e.ts}] ${e.type} ${e.name} ${e.data?JSON.stringify(e.data):""}`;
  });
  logBox.textContent = lines.join("\n");
}

function logEvent(type,name,data){ state.log.push({ts:new Date().toISOString(), type, name, data}); }
function saveState(){ localStorage.setItem("GNPv4_STATE", JSON.stringify(state)); }
function loadState(){ try{ const s=localStorage.getItem("GNPv4_STATE"); return s?JSON.parse(s):null; }catch(e){ return null; } }
function exportLog(){
  const blob = new Blob([JSON.stringify(state.log,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "gnp_audit_log.json"; a.click();
  URL.revokeObjectURL(url);
}
function hardReset(){
  if(!confirm("HARD RESET يمسح كل شيء. موافق؟")) return;
  clearTimer();
  localStorage.removeItem("GNPv4_STATE");
  state = {mode:"IDLE", i:-1, startedAt:null, stepStartedAt:null, timeLeft:0, log:[]};
  renderAll();
}
function clearTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function wordCount(t){ return (t||"").trim().split(/\s+/).filter(Boolean).length; }

/* =========================
   PDF STUDY (iOS-friendly)
========================= */
let pdfDoc = null;
let currentPage = 1;
let rendering = false;
let highlightMode = false;
let pageScale = 1.35;

const pdfInput = document.getElementById("pdfInput");
const loadPdfBtn = document.getElementById("loadPdfBtn");
const clearPdfBtn = document.getElementById("clearPdfBtn");
const prevBtn = document.getElementById("prevPageBtn");
const nextBtn = document.getElementById("nextPageBtn");
const toggleHLBtn = document.getElementById("toggleHighlightBtn");
const clearHLBtn = document.getElementById("clearHighlightsBtn");

const pdfStatus = document.getElementById("pdfStatus");
const pageInfo = document.getElementById("pageInfo");
const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");

const hlList = document.getElementById("hlList");
const pageNotes = document.getElementById("pageNotes");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const noteMsg = document.getElementById("noteMsg");

function keyHL(p){ return `GNP_HL_${p}`; }
function keyNote(p){ return `GNP_NOTE_${p}`; }

function getHighlights(p){
  try{ return JSON.parse(localStorage.getItem(keyHL(p))||"[]"); }catch(e){ return []; }
}
function setHighlights(p,arr){ localStorage.setItem(keyHL(p), JSON.stringify(arr||[])); }
function loadNote(p){ pageNotes.value = localStorage.getItem(keyNote(p)) || ""; }
function saveNote(p){ localStorage.setItem(keyNote(p), pageNotes.value || ""); }

function setPdfUiEnabled(on){
  prevBtn.disabled = !on;
  nextBtn.disabled = !on;
  toggleHLBtn.disabled = !on;
  clearHLBtn.disabled = !on;
  saveNoteBtn.disabled = !on;
}

function updatePdfLabels(){
  const total = pdfDoc ? pdfDoc.numPages : "-";
  pageInfo.textContent = `PAGE: ${pdfDoc ? currentPage : "-"} / ${total}`;
  pdfStatus.textContent = pdfDoc ? "PDF: loaded" : "PDF: not loaded";
}

async function renderPage(p){
  if(!pdfDoc || rendering) return;
  rendering = true;

  const page = await pdfDoc.getPage(p);
  const viewport = page.getViewport({ scale: pageScale });

  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);

  await page.render({canvasContext: ctx, viewport}).promise;

  // draw highlights
  const hls = getHighlights(currentPage);
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.fillStyle = "#ffe066";
  hls.forEach(r=>{
    ctx.fillRect(r.x, r.y, r.w, r.h);
  });
  ctx.restore();

  renderHlList();
  loadNote(currentPage);
  noteMsg.textContent = "";

  updatePdfLabels();
  rendering = false;
}

function renderHlList(){
  const hls = getHighlights(currentPage);
  if(!hls.length){ hlList.textContent = "(no highlights)"; return; }
  hlList.textContent = hls.map((r,i)=>`#${i+1} x:${Math.round(r.x)} y:${Math.round(r.y)} w:${Math.round(r.w)} h:${Math.round(r.h)}`).join("\n");
}

loadPdfBtn.addEventListener("click", async ()=>{
  try{
    const file = pdfInput.files?.[0];
    if(!file){ alert("اختار ملف PDF أول."); return; }

    // iOS-friendly: arrayBuffer
    const buf = await file.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
    currentPage = 1;

    setPdfUiEnabled(true);
    highlightMode = false;
    toggleHLBtn.textContent = "DRAW HIGHLIGHT: OFF";

    logEvent("PDF","LOAD",{name:file.name, pages: pdfDoc.numPages});
    saveState();

    await renderPage(currentPage);
  }catch(e){
    console.error(e);
    alert("فشل تحميل PDF. السبب غالبًا: pdfjs/worker. (تم طباعة الخطأ في console)");
    logEvent("PDF_ERROR","LOAD_FAIL",{err:String(e)});
    saveState();
  }
});

clearPdfBtn.addEventListener("click", ()=>{
  pdfDoc = null;
  currentPage = 1;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  setPdfUiEnabled(false);
  updatePdfLabels();
  hlList.textContent = "";
  pageNotes.value = "";
  noteMsg.textContent = "";
  highlightMode = false;
  toggleHLBtn.textContent = "DRAW HIGHLIGHT: OFF";
  logEvent("PDF","CLEAR",{});
  saveState();
});

nextBtn.addEventListener("click", async ()=>{
  if(!pdfDoc) return;
  if(currentPage >= pdfDoc.numPages) return;
  currentPage++;
  await renderPage(currentPage);
});

prevBtn.addEventListener("click", async ()=>{
  if(!pdfDoc) return;
  if(currentPage <= 1) return;
  currentPage--;
  await renderPage(currentPage);
});

toggleHLBtn.addEventListener("click", ()=>{
  if(!pdfDoc) return;
  highlightMode = !highlightMode;
  toggleHLBtn.textContent = highlightMode ? "DRAW HIGHLIGHT: ON" : "DRAW HIGHLIGHT: OFF";
});

clearHLBtn.addEventListener("click", ()=>{
  if(!pdfDoc) return;
  setHighlights(currentPage, []);
  renderPage(currentPage);
});

saveNoteBtn.addEventListener("click", ()=>{
  if(!pdfDoc) return;
  saveNote(currentPage);
  noteMsg.innerHTML = `<span class="good">Saved.</span>`;
});

let drag = null;

function getPos(evt){
  const rect = canvas.getBoundingClientRect();
  const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
  const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;

  // map to canvas pixels
  const x = (clientX - rect.left) * (canvas.width / rect.width);
  const y = (clientY - rect.top) * (canvas.height / rect.height);
  return {x,y};
}

function startDrag(evt){
  if(!highlightMode || !pdfDoc) return;
  evt.preventDefault();
  const p = getPos(evt);
  drag = {x0:p.x, y0:p.y, x1:p.x, y1:p.y};
}

function moveDrag(evt){
  if(!drag || !highlightMode || !pdfDoc) return;
  evt.preventDefault();
  const p = getPos(evt);
  drag.x1 = p.x; drag.y1 = p.y;
  // redraw page then overlay current drag rect quickly
  renderPage(currentPage).then(()=>{
    const x = Math.min(drag.x0, drag.x1);
    const y = Math.min(drag.y0, drag.y1);
    const w = Math.abs(drag.x1 - drag.x0);
    const h = Math.abs(drag.y1 - drag.y0);
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#ffe066";
    ctx.fillRect(x,y,w,h);
    ctx.restore();
  });
}

function endDrag(evt){
  if(!drag || !highlightMode || !pdfDoc) return;
  evt.preventDefault();
  const x = Math.min(drag.x0, drag.x1);
  const y = Math.min(drag.y0, drag.y1);
  const w = Math.abs(drag.x1 - drag.x0);
  const h = Math.abs(drag.y1 - drag.y0);
  drag = null;

  if(w < 6 || h < 6) { renderPage(currentPage); return; }

  const hls = getHighlights(currentPage);
  hls.push({x,y,w,h});
  setHighlights(currentPage, hls);

  logEvent("PDF","HIGHLIGHT_ADD",{page: currentPage, rect:{x,y,w,h}});
  saveState();

  renderPage(currentPage);
}

// Mouse + Touch
canvas.addEventListener("mousedown", startDrag);
canvas.addEventListener("mousemove", moveDrag);
window.addEventListener("mouseup", endDrag);

canvas.addEventListener("touchstart", startDrag, {passive:false});
canvas.addEventListener("touchmove", moveDrag, {passive:false});
canvas.addEventListener("touchend", endDrag, {passive:false});

// init
setPdfUiEnabled(false);
updatePdfLabels();
</script>

</body>
</html>
